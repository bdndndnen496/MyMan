<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Client-Management</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2 { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom:20px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#f0f0f0; }
    button { padding:4px 8px; }
  </style>
</head>
<body>
  <h1>Client-Ãœbersicht</h1>

  <h2>ðŸ“¥ Backlog (mehr als 2â€¯Min offline)</h2>
  <table id="tbl-backlog">
    <thead><tr><th>IP</th><th>User</th><th>Status</th><th>Letzter Kontakt</th><th>Connect</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="groups"></div>

  <script>
    const ENDPOINT = "/clients";

    async function fetchClients(){
      const res=await fetch(ENDPOINT);
      const {online,offline,backlog}=await res.json();
      render(backlog,online,offline);
    }

    function render(backlog,online,offline){
      // Backlog
      let tb=document.querySelector("#tbl-backlog tbody");
      tb.innerHTML="";
      backlog.forEach(c=>{
        tb.innerHTML+=`
          <tr>
            <td>${c.public_ip}</td>
            <td>${c.username}</td>
            <td>${c.status}</td>
            <td>${new Date(c.last_seen*1000).toLocaleTimeString()}</td>
            <td><button onclick="goDetail('${c.id}')">Connect</button></td>
          </tr>`;
      });

      // Gruppen nach Netzwerk
      const all=[...online,...offline];
      const byNet={};
      all.forEach(c=>{
        (byNet[c.network]=byNet[c.network]||[]).push(c);
      });
      const cont=document.getElementById("groups");
      cont.innerHTML="";
      for(const net in byNet){
        cont.innerHTML+=`<h2>Netzwerk ${net}</h2>
          <table>
            <thead><tr><th>IP</th><th>User</th><th>Status</th><th>Connect</th></tr></thead>
            <tbody>
              ${byNet[net].map(c=>`
                <tr>
                  <td>${c.public_ip}</td>
                  <td>${c.username}</td>
                  <td>${c.status}</td>
                  <td><button onclick="goDetail('${c.id}')">Connect</button></td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      }
    }

    function goDetail(id){
      window.location.href=`/client/${id}`;
    }

    fetchClients();
    setInterval(fetchClients,30000);
  </script>
</body>
</html>
