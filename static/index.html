<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Client-Management Dashboard</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Container -->
  <div id="overview" class="container mx-auto p-6">

    <!-- Header -->
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Client-Management</h1>
      <p class="text-gray-600 mt-1">√úbersicht aller verbundenen Clients</p>
    </header>

    <!-- Backlog Section -->
    <section class="mb-8">
      <h2 class="text-2xl font-semibold mb-4">üì• Backlog (mehr als 2 Min offline)</h2>
      <div class="overflow-x-auto">
        <table id="tbl-backlog" class="min-w-full bg-white shadow rounded-lg overflow-hidden">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2 text-left">Public IP</th>
              <th class="px-4 py-2 text-left">Username</th>
              <th class="px-4 py-2 text-left">Status</th>
              <th class="px-4 py-2 text-left">Letzter Kontakt</th>
              <th class="px-4 py-2 text-left">Connect</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            <!-- Dynamisch gef√ºllt -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Groups by Network -->
    <section id="groups" class="space-y-8">
      <!-- Dynamisch gef√ºllt -->
    </section>

  </div>

  <!-- Detail View -->
  <div id="detail" class="container mx-auto p-6 hidden">
    <button onclick="goHome()" class="mb-4 inline-flex items-center px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded">
      ‚Üê Zur√ºck zur √úbersicht
    </button>
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Client: <span id="cid"></span></h1>
    </header>

    <div class="bg-white shadow rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-semibold mb-4">Specs &amp; Info</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <p><strong>Public IP:</strong> <span id="sp-public"></span></p>
        <p><strong>Private IP:</strong> <span id="sp-private"></span></p>
        <p><strong>OS:</strong> <span id="sp-os"></span></p>
        <p><strong>CPU:</strong> <span id="sp-cpu"></span></p>
        <p><strong>RAM:</strong> <span id="sp-ram"></span></p>
        <p><strong>Disk:</strong> <span id="sp-disk"></span></p>
        <p><strong>Netzwerk:</strong> <span id="sp-net"></span></p>
      </div>
    </div>

    <div class="bg-white shadow rounded-lg p-6 mb-8">
      <h2 class="text-2xl font-semibold mb-4">Remote Konsole</h2>
      <div id="console" class="h-48 overflow-auto bg-black text-green-400 p-4 rounded mb-4"></div>
      <div class="flex space-x-2">
        <input id="cmd" type="text" placeholder="Befehl eingeben‚Ä¶"
               class="flex-1 border border-gray-300 rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        <button id="send"
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded">Senden</button>
        <button id="tm-btn"
                class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded">Taskmanager</button>
      </div>
    </div>
  </div>

  <!-- Modal Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden"></div>

  <!-- Taskmanager Modal -->
  <div id="tm-modal" class="fixed inset-0 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl mx-4 p-6 relative">
      <button id="tm-close"
              class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">&times;</button>
      <h3 class="text-2xl font-semibold mb-4">Live Taskmanager</h3>
      <div class="tabs flex border-b mb-4">
        <div class="tab px-4 py-2 cursor-pointer active" data-cmd="tasklist">Prozesse</div>
        <div class="tab px-4 py-2 cursor-pointer" data-cmd="wmic cpu get loadpercentage">CPU</div>
        <div class="tab px-4 py-2 cursor-pointer" data-cmd="wmic OS get FreePhysicalMemory,TotalVisibleMemorySize">Memory</div>
        <div class="tab px-4 py-2 cursor-pointer" data-cmd="wmic logicaldisk get size,freespace">Disk</div>
      </div>
      <div id="tm-contents" class="space-y-4">
        <div class="tab-content active max-h-64 overflow-auto bg-gray-100 p-4 rounded" id="content-0"></div>
        <div class="tab-content max-h-64 overflow-auto bg-gray-100 p-4 rounded" id="content-1"></div>
        <div class="tab-content max-h-64 overflow-auto bg-gray-100 p-4 rounded" id="content-2"></div>
        <div class="tab-content max-h-64 overflow-auto bg-gray-100 p-4 rounded" id="content-3"></div>
      </div>
    </div>
  </div>

  <script>
    const ENDPOINT = "/clients";
    let adminWs;

    // √úberblick laden
    async function fetchClients(){
      try {
        const res = await fetch(ENDPOINT);
        const { online, offline, backlog } = await res.json();
        renderOverview(online, offline, backlog);
      } catch (e) {
        console.error("Fehler beim Laden der Client-Daten:", e);
      }
    }

    function renderOverview(online, offline, backlog){
      // Backlog Tabelle f√ºllen
      const tb = document.querySelector("#tbl-backlog tbody");
      tb.innerHTML = "";
      backlog.forEach(c => {
        const last = new Date(c.last_seen*1000).toLocaleTimeString();
        const row = document.createElement("tr");
        row.className = "divide-x";

        row.innerHTML = `
          <td class="px-4 py-2">${c.public_ip}</td>
          <td class="px-4 py-2">${c.username}</td>
          <td class="px-4 py-2 text-red-600 font-semibold">${c.status}</td>
          <td class="px-4 py-2">${last}</td>
          <td class="px-4 py-2">
            <button onclick="showDetail('${c.id}')"
                    class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded">
              Connect
            </button>
          </td>`;
        tb.appendChild(row);
      });

      // Gruppen nach Netzwerk
      const all = [...online, ...offline];
      const byNet = {};
      all.forEach(c => {
        if (!byNet[c.network]) byNet[c.network] = [];
        byNet[c.network].push(c);
      });
      const cont = document.getElementById("groups");
      cont.innerHTML = "";

      for (const [network, clients] of Object.entries(byNet)) {
        const section = document.createElement("section");
        section.className = "mb-8";
        section.innerHTML = `
          <h2 class="text-2xl font-semibold mb-4">Netzwerk: ${network}</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white shadow rounded-lg overflow-hidden">
              <thead class="bg-gray-200">
                <tr>
                  <th class="px-4 py-2">Public IP</th>
                  <th class="px-4 py-2">Username</th>
                  <th class="px-4 py-2">Status</th>
                  <th class="px-4 py-2">Connect</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                ${clients.map(c => {
                  const statusColor = c.status==="Online"?"text-green-600":"text-gray-600";
                  return `
                  <tr>
                    <td class="px-4 py-2">${c.public_ip}</td>
                    <td class="px-4 py-2">${c.username}</td>
                    <td class="px-4 py-2 ${statusColor} font-semibold">${c.status}</td>
                    <td class="px-4 py-2">
                      <button onclick="showDetail('${c.id}')"
                              class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded">
                        Connect
                      </button>
                    </td>
                  </tr>`}).join("")}
              </tbody>
            </table>
          </div>`;

        cont.appendChild(section);
      }
    }

    // Detail-Ansicht wechseln
    function showDetail(id){
      location.hash = id;
    }
    function goHome(){
      location.hash = "";
    }

    window.onhashchange = () => {
      const cid = location.hash.slice(1);
      const overviewEl = document.getElementById("overview");
      const detailEl   = document.getElementById("detail");
      if (cid) {
        overviewEl.classList.add("hidden");
        detailEl.classList.remove("hidden");
        initDetail(cid);
      } else {
        detailEl.classList.add("hidden");
        overviewEl.classList.remove("hidden");
        if (adminWs) adminWs.close();
      }
    };

    async function initDetail(cid){
      document.getElementById("cid").textContent = cid;
      document.getElementById("console").textContent = "";
      setupWS(cid);
      await loadSpecs(cid);
    }

    // Spezifikationen laden
    async function loadSpecs(cid){
      try {
        const res = await fetch(ENDPOINT);
        const { online, offline, backlog } = await res.json();
        const all = [...online, ...offline, ...backlog];
        const c = all.find(x => x.id === cid);
        if (!c) return;
        const info = c.info || {};
        document.getElementById("sp-public").textContent  = c.public_ip;
        document.getElementById("sp-private").textContent = c.private_ip;
        document.getElementById("sp-os").textContent      = info.os || "";
        document.getElementById("sp-cpu").textContent     = info.cpu_percent || "";
        document.getElementById("sp-ram").textContent     = `${info.ram_used||""}/${info.ram_total||""}`;
        document.getElementById("sp-disk").textContent    = `${info.disk_used||""}/${info.disk_total||""}`;
        document.getElementById("sp-net").textContent     = c.network;
      } catch (e) {
        console.error("Fehler beim Laden der Specs:", e);
      }
    }

    // WebSocket einrichten
    function setupWS(cid){
      adminWs = new WebSocket((location.protocol==="https:"?"wss":"ws")+`://${location.host}/ws/admin`);
      adminWs.onopen = () => console.log("Admin WS verbunden");
      adminWs.onmessage = ev => {
        const text = ev.data + "\n";
        document.getElementById("console").textContent += text;
        document.querySelectorAll(".tab").forEach((tab,i)=>{
          if (tab.classList.contains("active")) {
            document.getElementById(`content-${i}`).textContent += text;
          }
        });
      };
      adminWs.onclose = () => console.log("Admin WS getrennt");
    }

    // Konsole: Befehl senden
    document.getElementById("send").onclick = () => {
      const cmd = document.getElementById("cmd").value.trim();
      const cid = location.hash.slice(1);
      if (cmd && adminWs) {
        adminWs.send(JSON.stringify({ target: cid, cmd }));
        document.getElementById("cmd").value = "";
      }
    };

    // Taskmanager Modal
    document.getElementById("tm-btn").onclick = () => {
      document.getElementById("overlay").classList.remove("hidden");
      document.getElementById("tm-modal").classList.remove("hidden");
      document.querySelector(".tab.active").click();
    };
    document.getElementById("tm-close").onclick = () => {
      document.getElementById("overlay").classList.add("hidden");
      document.getElementById("tm-modal").classList.add("hidden");
    };
    document.querySelectorAll(".tab").forEach((tab,i) => {
      tab.onclick = () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active", "text-blue-600"));
        document.querySelectorAll(".tab-content").forEach(c => c.classList.add("hidden"));
        tab.classList.add("active", "text-blue-600");
        const contentEl = document.getElementById(`content-${i}`);
        contentEl.classList.remove("hidden");
        contentEl.textContent = "";
        const cid = location.hash.slice(1);
        if (adminWs) adminWs.send(JSON.stringify({ target: cid, cmd: tab.dataset.cmd }));
      };
    });

    // Init √úbersicht
    fetchClients();
    setInterval(fetchClients, 30000);
    window.onhashchange();  // initial

  </script>
</body>
</html>
