<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Client Manager</title>
<style>
  body { font-family: sans-serif; }
  pre { background: #f0f0f0; padding: 10px; }
</style>
</head>
<body>
<h1>Client Manager</h1>
<div id="clients"></div>
<div id="client-info"></div>
<input type="text" id="cmd">
<button onclick="sendCommand()">Send</button>
<button onclick="startScreen()">Start Screen</button>
<button onclick="stopScreen()">Stop Screen</button>
<img id="screen" style="max-width: 100%;">
<pre id="output"></pre>

<script>
let ws, selectedClient;

function loadClients() {
  fetch("/clients").then(r => r.json()).then(data => {
    let html = "";
    for (const [net, clients] of Object.entries(data)) {
      html += `<h2>${net}</h2><ul>`;
      clients.forEach(c => {
        html += `<li>${c.hostname} (${c.status}) <button onclick="select('${c.id}')">Select</button></li>`;
      });
      html += "</ul>";
    }
    document.getElementById("clients").innerHTML = html;
  });
}

function select(id) {
  selectedClient = id;
  let info = Object.entries(getClientInfo(id)).map(([k,v]) => `${k}: ${v}`).join("\n");
  document.getElementById("client-info").innerHTML = `<pre>${info}</pre>`;
}

function getClientInfo(id) {
  let all = document.querySelector("#clients").innerHTML;
  return all[id] || {};
}

function connectAdmin() {
  ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws/admin");
  ws.onmessage = e => {
    if (typeof e.data === "string")
      document.getElementById("output").textContent += e.data + "\n";
    else
      document.getElementById("screen").src = URL.createObjectURL(new Blob([e.data]));
  };
}

function sendCommand() {
  if (selectedClient && ws && ws.readyState === 1) {
    ws.send(JSON.stringify({ target: selectedClient, cmd: document.getElementById("cmd").value }));
  }
}

function startScreen() {
  if (selectedClient) ws.send(JSON.stringify({ target: selectedClient, cmd: "screenshot_start" }));
}

function stopScreen() {
  if (selectedClient) ws.send(JSON.stringify({ target: selectedClient, cmd: "screenshot_stop" }));
}

setInterval(loadClients, 5000);
loadClients();
connectAdmin();
</script>
</body>
</html>
