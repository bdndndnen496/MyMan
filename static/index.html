<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Client-Management</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1, h2 { margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    button { padding: 4px 8px; margin: 2px; }
    .backlog { background: #ffeeee; }

    /* Detail‚ÄëAnsicht */
    #detail { display: none; }
    .specs p { margin: 4px 0; }
    #console { background: #111; color: #0f0; padding: 10px; height: 200px; overflow: auto; }
    #cmd { width: 70%; padding: 6px; }
    #send { padding: 6px 12px; }

    /* Modal f√ºr Taskmanager */
    .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: #fff; padding: 20px; border-radius: 6px; max-width: 600px; width: 90%; max-height: 80vh; overflow: auto; }
    .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 10px; }
    .tab { padding: 8px 16px; cursor: pointer; }
    .tab.active { border-bottom: 2px solid #333; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>

  <!-- √úbersicht -->
  <div id="overview">
    <h1>Client-Management</h1>

    <h2>üì• Backlog (mehr als 2‚ÄØMin offline)</h2>
    <table id="tbl-backlog">
      <thead><tr><th>Public IP</th><th>Username</th><th>Status</th><th>Letzter Kontakt</th><th>Connect</th></tr></thead>
      <tbody></tbody>
    </table>

    <div id="groups"></div>
  </div>

  <!-- Detail-Ansicht -->
  <div id="detail">
    <button onclick="goHome()">‚Üê Zur√ºck zur √úbersicht</button>
    <h1>Client: <span id="cid"></span></h1>
    <div class="specs">
      <h2>Specs &amp; Info</h2>
      <p><strong>Public IP:</strong> <span id="sp-public"></span></p>
      <p><strong>Private IP:</strong> <span id="sp-private"></span></p>
      <p><strong>OS:</strong> <span id="sp-os"></span></p>
      <p><strong>CPU:</strong> <span id="sp-cpu"></span></p>
      <p><strong>RAM:</strong> <span id="sp-ram"></span></p>
      <p><strong>Disk:</strong> <span id="sp-disk"></span></p>
      <p><strong>Netzwerk:</strong> <span id="sp-net"></span></p>
    </div>

    <h2>Remote Konsole</h2>
    <div id="console"></div>
    <input id="cmd" placeholder="Befehl eingeben‚Ä¶" />
    <button id="send">Senden</button>
    <button id="tm-btn">Taskmanager</button>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="tm-modal">
      <h3>Live Taskmanager</h3>
      <div class="tabs">
        <div class="tab active" data-cmd="tasklist">Prozesse</div>
        <div class="tab" data-cmd="wmic cpu get loadpercentage">CPU</div>
        <div class="tab" data-cmd="wmic OS get FreePhysicalMemory,TotalVisibleMemorySize">Memory</div>
        <div class="tab" data-cmd="wmic logicaldisk get size,freespace">Disk</div>
      </div>
      <div id="tm-contents">
        <div class="tab-content active" id="content-0"></div>
        <div class="tab-content" id="content-1"></div>
        <div class="tab-content" id="content-2"></div>
        <div class="tab-content" id="content-3"></div>
      </div>
      <button id="tm-close">Schlie√üen</button>
    </div>
  </div>

  <script>
    const ENDPOINT = "/clients";
    let adminWs;

    // √úberblick laden
    async function fetchClients(){
      const res = await fetch(ENDPOINT);
      const { online, offline, backlog } = await res.json();
      renderOverview(online, offline, backlog);
    }
    function renderOverview(online, offline, backlog){
      // Backlog
      const tb = document.querySelector("#tbl-backlog tbody");
      tb.innerHTML = "";
      backlog.forEach(c => {
        tb.innerHTML += `
          <tr class="backlog">
            <td>${c.public_ip}</td>
            <td>${c.username}</td>
            <td>${c.status}</td>
            <td>${new Date(c.last_seen*1000).toLocaleTimeString()}</td>
            <td><button onclick="showDetail('${c.id}')">Connect</button></td>
          </tr>`;
      });
      // Gruppen nach Netzwerk
      const all = [...online, ...offline];
      const byNet = {};
      all.forEach(c => {
        byNet[c.network] = byNet[c.network]||[];
        byNet[c.network].push(c);
      });
      const cont = document.getElementById("groups");
      cont.innerHTML = "";
      for(const net in byNet){
        cont.innerHTML += `<h2>Netzwerk ${net}</h2>
          <table>
            <thead><tr><th>Public IP</th><th>Username</th><th>Status</th><th>Connect</th></tr></thead>
            <tbody>
              ${byNet[net].map(c=>`
                <tr>
                  <td>${c.public_ip}</td>
                  <td>${c.username}</td>
                  <td>${c.status}</td>
                  <td><button onclick="showDetail('${c.id}')">Connect</button></td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      }
    }

    // Detail‚ÄëAnsicht aufbauen
    async function loadSpecs(cid){
      const res = await fetch(ENDPOINT);
      const { online, offline, backlog } = await res.json();
      const all = [...online, ...offline, ...backlog];
      const c = all.find(x=>x.id===cid);
      if(!c) return;
      document.getElementById("sp-public").textContent = c.public_ip;
      document.getElementById("sp-private").textContent = c.private_ip;
      // Zusatzinfos aus client_infos
      const info = c.info||{};
      document.getElementById("sp-os").textContent = info.os||"";
      document.getElementById("sp-cpu").textContent = info.cpu_percent||"";
      document.getElementById("sp-ram").textContent = `${info.ram_used||""}/${info.ram_total||""}`;
      document.getElementById("sp-disk").textContent = `${info.disk_used||""}/${info.disk_total||""}`;
      document.getElementById("sp-net").textContent = c.network;
    }

    // WebSocket f√ºr Admin‚ÄëBefehle
    function setupWS(){
      adminWs = new WebSocket((location.protocol==="https:"?"wss":"ws")+`://${location.host}/ws/admin`);
      adminWs.onmessage = ev => {
        const text = ev.data + "\n";
        document.getElementById("console").textContent += text;
        document.querySelectorAll(".tab").forEach((t,i)=>{
          if(t.classList.contains("active")){
            document.getElementById(`content-${i}`).textContent += text;
          }
        });
      };
    }

    // Ansicht wechseln
    function showDetail(id){
      location.hash = id;
    }
    function goHome(){
      location.hash = "";
    }
    window.onhashchange = () => {
      const cid = location.hash.slice(1);
      if(cid){
        // Detail
        document.getElementById("overview").style.display = "none";
        document.getElementById("detail").style.display = "block";
        document.getElementById("cid").textContent = cid;
        document.getElementById("console").textContent = "";
        setupWS();
        loadSpecs(cid);
      } else {
        // √úbersicht
        document.getElementById("detail").style.display = "none";
        document.getElementById("overview").style.display = "block";
        if(adminWs) adminWs.close();
      }
    };

    // Remote Konsole
    document.getElementById("send").onclick = ()=>{
      const cmd = document.getElementById("cmd").value;
      const cid = location.hash.slice(1);
      adminWs.send(JSON.stringify({ target: cid, cmd }));
      document.getElementById("cmd").value = "";
    };

    // Taskmanager‚ÄëPopup
    document.getElementById("tm-btn").onclick = ()=>{
      document.getElementById("overlay").style.display = "block";
      document.getElementById("tm-modal").style.display = "block";
      document.querySelector(".tab.active").click();
    };
    document.getElementById("tm-close").onclick = ()=>{
      document.getElementById("overlay").style.display = "none";
      document.getElementById("tm-modal").style.display = "none";
    };
    document.querySelectorAll(".tab").forEach((tab,i)=>{
      tab.onclick = ()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(`content-${i}`).classList.add("active");
        document.getElementById(`content-${i}`).textContent = "";
        const cid = location.hash.slice(1);
        adminWs.send(JSON.stringify({ target: cid, cmd: tab.dataset.cmd }));
      };
    });

    // Init
    fetchClients();
    setInterval(fetchClients, 30000);
    window.onhashchange();  // initial
  </script>
</body>
</html>
