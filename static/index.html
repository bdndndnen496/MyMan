<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client Manager</title>
</head>
<body>
  <h1>Client Manager</h1>

  <div id="clientList"></div>

  <h2>Selected Client: <span id="selectedClient"></span></h2>
  <textarea id="output" cols="80" rows="10" readonly></textarea><br>

  <input type="text" id="command" placeholder="Enter command">
  <button onclick="sendCommand()">Send Command</button>
  <button onclick="startScreen()">Start Screen</button>
  <button onclick="stopScreen()">Stop Screen</button>

  <img id="screen" style="display:none; max-width:100%; border:1px solid #000;">

  <script>
    let selectedClient = null;
    let ws = null;

    function refreshClients() {
      fetch('/clients')
        .then(r => r.json())
        .then(data => {
          const div = document.getElementById('clientList');
          div.innerHTML = '';
          data.clients.forEach(c => {
            const btn = document.createElement('button');
            btn.innerText = `${c.id} (${c.status})`;
            btn.onclick = () => selectClient(c.id);
            div.appendChild(btn);
          });
        });
    }

    function selectClient(clientId) {
      selectedClient = clientId;
      document.getElementById('selectedClient').innerText = clientId;
      document.getElementById('output').value = '';
    }

    function sendCommand() {
      if (selectedClient && ws) {
        const cmd = document.getElementById('command').value;
        ws.send(JSON.stringify({ target: selectedClient, cmd: cmd }));
      }
    }

    function startScreen() {
      if (selectedClient && ws) {
        ws.send(JSON.stringify({ target: selectedClient, cmd: 'screenshot_start' }));
      }
    }

    function stopScreen() {
      if (selectedClient && ws) {
        ws.send(JSON.stringify({ target: selectedClient, cmd: 'screenshot_stop' }));
        document.getElementById('screen').style.display = 'none';
      }
    }

    window.onload = () => {
      refreshClients();
      setInterval(refreshClients, 5000);

      ws = new WebSocket(`wss://${location.host}/ws/admin`);

      ws.onmessage = (event) => {
        if (event.data.startsWith('[')) {
          const endIdx = event.data.indexOf(']');
          const clientId = event.data.slice(1, endIdx);
          const msg = event.data.slice(endIdx + 1);
          if (clientId === selectedClient) {
            document.getElementById('output').value += msg + '\n';
          }
        } else if (event.data instanceof Blob) {
          const img = document.getElementById('screen');
          img.src = URL.createObjectURL(event.data);
          img.style.display = 'block';
        }
      };
    };
  </script>
</body>
</html>
